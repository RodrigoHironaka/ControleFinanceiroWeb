@using ControlFinWeb.Dominio.ObjetoValor
@model IEnumerable<ControlFinWeb.App.ViewModels.FaturaVM>

@{
    ViewData["Title"] = "Pesquisa";
}

<div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">PESQUISA DE FATURAS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="javascript:window.location.reload()"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" id="CartaoId" asp-items="ViewBag.Cartoes">
                        <option value="0">---Selecione um Cartão---</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input id="SomenteAberto" class="form-check-input" type="checkbox" checked role="switch">
                        <label class="form-check-label" for="flexSwitchCheckChecked">SomenteAberto</label>
                    </div>
                </div>
                  <div class="col-md-4">
                    <button type="button" class="w-100 btn btn-dark" onclick="Filtrar()">Filtrar</button>
                </div>
            </div>

            <table id="tabelaPesquisaFatura" class="table table-bordered table-striped table-hover" style="font-size: 14px;">
                <thead>
                    <tr>
                        <th width="50">Mês/Ano</th>
                        <th>Descrição</th>
                        <th width="100">Valor</th>
                        <th width="70">Situação</th>
                        <th style="text-align:center">
                            <button class="btn btn-sm btn-dark novo" data-id="0"><i class="badge-info bi-plus-lg"></i> Nova Fatura</button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null)
                    {
                        @foreach (var item in Model)
                        {
                            <tr ondblclick="MostrarDetalhesFatura(@item.Id)">
                                <td>
                                    @Convert.ToDateTime(item.MesAnoReferencia).ToString("MM/yyyy")
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.CartaoVM.Nome)
                                </td>
                                <td align="right">
                                    @Html.DisplayFor(modelItem => item.ValorFatura)

                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.SituacaoFatura)
                                </td>
                                <td align="center">
                                    <button class="btn btn-sm btn-primary modal-trigger editar" data-id="@item.Id"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-sm btn-danger modal-trigger" onclick="ExibirModalExcluir(@item.Id)"><i class="bi bi-x-square"></i></button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!--Modal Excluir-->
<div class="modal fade modal-excluir" id="modal-excluir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white">Exluir?</h5>
            </div>
            <div class="modal-body">
                <p>ATENÇÃO: Ao excluir essa fatura todos os itens adicionados serão excluídos também!</p>
                <p>Deseja continuar mesmo assim?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-danger btnConfirmar">Confirmar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts
    {
    <script>
        $(document).ready(function() {
            $('#tabelaPesquisaFatura').DataTable({
                order: [[1, 'asc'], [0, 'asc']],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json"
                },
                paging: false,
                info: false,
                searching: false,

            });
        });
        function MostrarDetalhesFatura(idFatura) {
            $("#modal").modal("hide");
            window.location.href = 'Index?idFatura=' + idFatura;
        }

        $(function() {
            $(".novo").click(function() {
                $("#modal").modal("hide");
                var id = $(this).attr("data-id");
                $("#modal").load("Editar?id=" + id, function() {
                    $(".modal-title").html("NOVO REGISTRO");
                    $("#modal").modal("show");
                })
            });

            $(".editar").click(function() {
                $("#modal").modal("hide");
                var id = $(this).attr("data-id");
                $("#modal").load("Editar?id=" + id, function() {
                    $(".modal-title").html("ALTERANDO REGISTRO");
                    $("#modal").modal("show");
                })
            });
        });


        $(document).ready(function() {
            $(".modal-excluir").modal();
        });

        function ExibirModalExcluir(id) {
            $("#modal-excluir").modal("show");
            $(".btnConfirmar").on("click", function() {
                $.ajax({
                    method: "POST",
                    url: "/Faturas/Deletar",
                    data: { id: id },
                    success: function() {
                        $("#modal-excluir").modal("hide");
                        $("#modal").modal("hide");
                        $("#modal").load("Pesquisa", function() {
                            $("#modal").modal("show");
                        })
                    },
                    error: function() {
                        $("#modal-excluir").modal("hide");
                        $("#mensagem").addClass('alert alert-danger').html("<strong>Erro!</strong> Não é possível excluir, entre em contato com o suporte!").delay(10000).fadeOut(400);
                    }
                });
            })
        }

        function Filtrar() {
            var cartaoId = $("#CartaoId").val();
            var somenteAtivos = $("#SomenteAberto").prop("checked");
           
            $("#modal").modal("hide");
            $("#modal").load("Pesquisa", {cartaoId: cartaoId, somenteAtivos: somenteAtivos}, function() {
                $("#modal").modal("show");
            })
        }

    </script>
    }
